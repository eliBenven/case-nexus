<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case Nexus â€” AI Legal Caseload Intelligence</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/main.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/15.0.6/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.2.4/purify.min.js"></script>
</head>
<body>
    <!-- Header -->
    <header id="header">
        <div class="header-left">
            <div class="logo">
                <span class="logo-text">Case Nexus</span>
            </div>
            <span class="tagline">AI-Powered Legal Caseload Intelligence</span>
        </div>
        <div class="header-center">
            <div id="token-viz" class="token-viz">
                <div class="token-viz-label">
                    <span class="token-viz-icon">&bull;</span>
                    <span>Opus 4.6 Tokens</span>
                </div>
                <div class="token-viz-bar-wrap">
                    <div id="token-viz-bar" class="token-viz-bar" style="width: 0%"></div>
                </div>
                <div class="token-viz-stats">
                    <span id="token-viz-total" class="token-viz-total">0</span>
                    <span id="token-viz-cap" class="token-viz-cap">/ 1M context</span>
                </div>
                <div class="token-viz-breakdown">
                    <span class="token-chip input-chip"><span class="chip-dot"></span>In: <strong id="tv-input">0</strong></span>
                    <span class="token-chip thinking-chip"><span class="chip-dot"></span>Think: <strong id="tv-thinking">0</strong></span>
                    <span class="token-chip output-chip"><span class="chip-dot"></span>Out: <strong id="tv-output">0</strong></span>
                    <span class="token-chip calls-chip"><strong id="tv-calls">0</strong> calls</span>
                </div>
            </div>
        </div>
        <div class="header-right">
            <button id="btn-chat-toggle" class="btn btn-chat-toggle hidden" title="Ask your caseload anything">
                Chat
            </button>
            <span id="legal-corpus-badge" class="legal-corpus-badge hidden" title="Real statutory text loaded from official sources">
                <span id="lc-stats">Legal Corpus</span>
            </span>
            <span class="model-badge">Claude Opus 4.6</span>
            <span id="status-badge" class="status-badge">Ready</span>
        </div>
    </header>

    <!-- Main Layout -->
    <div id="app" class="app-layout">
        <!-- Left Sidebar: Case List -->
        <aside id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h2>Caseload</h2>
                <div id="caseload-stats" class="caseload-stats hidden">
                    <span id="stat-total" class="stat">0</span>
                    <span id="stat-felonies" class="stat felony">0 F</span>
                    <span id="stat-misdemeanors" class="stat misdemeanor">0 M</span>
                </div>
            </div>
            <div class="sidebar-controls">
                <input type="text" id="case-search" class="case-search" placeholder="Search cases..." disabled>
                <select id="case-filter" class="case-filter" disabled>
                    <option value="all">All Cases</option>
                    <option value="felony">Felonies</option>
                    <option value="misdemeanor">Misdemeanors</option>
                    <option value="active">Active</option>
                    <option value="plea_pending">Plea Pending</option>
                    <option value="trial_scheduled">Trial Scheduled</option>
                    <option value="bench_warrant">Bench Warrant</option>
                </select>
            </div>
            <div id="case-list" class="case-list">
                <div class="empty-state" id="cms-connect-state">
                    <div class="cms-badge">
                        <span class="cms-dot"></span>
                        Fulton County Superior Court
                    </div>
                    <p class="cms-status">Case Management System</p>
                    <button id="btn-load-demo" class="btn btn-primary btn-load">Sync Caseload</button>
                    <p class="hint">Pull assigned cases from court CMS</p>
                </div>
            </div>
        </aside>

        <!-- Center: Main Content -->
        <main id="main-content" class="main-content">
            <!-- Welcome / Dashboard View -->
            <div id="view-welcome" class="view active">
                <div class="welcome-hero">
                    <h1>Case Nexus</h1>
                    <p class="welcome-subtitle">AI-powered intelligence for public defenders</p>
                    <div class="welcome-features">
                        <div class="feature-card">
                            <div class="feature-icon-text">01</div>
                            <h3>Health Check</h3>
                            <p>Scan all 500 cases for deadline risks, cross-case connections, and strategic opportunities</p>
                            <span class="feature-tag">1M Context Window</span>
                        </div>
                        <div class="feature-card">
                            <div class="feature-icon-text">02</div>
                            <h3>Deep Analysis</h3>
                            <p>Individual case strategy with visible AI reasoning</p>
                            <span class="feature-tag">Extended Thinking</span>
                        </div>
                        <div class="feature-card">
                            <div class="feature-icon-text">03</div>
                            <h3>Adversarial Sim</h3>
                            <p>Watch prosecution vs defense debate in real-time</p>
                            <span class="feature-tag">Dual Thinking Chains</span>
                        </div>
                        <div class="feature-card">
                            <div class="feature-icon-text">04</div>
                            <h3>Motion Drafting</h3>
                            <p>Generate comprehensive legal motions</p>
                            <span class="feature-tag">128K Output</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dashboard View -->
            <div id="view-dashboard" class="view">
                <!-- Command Center: Stats + Actions -->
                <div class="command-center">
                    <div class="command-stats">
                        <div class="stat-pill"><span class="stat-pill-value" id="dash-total">0</span> Cases</div>
                        <div class="stat-pill felony"><span class="stat-pill-value" id="dash-felonies">0</span> Felonies</div>
                        <div class="stat-pill misdemeanor"><span class="stat-pill-value" id="dash-misdemeanors">0</span> Misdemeanors</div>
                        <div class="stat-pill"><span class="stat-pill-value" id="dash-active">0</span> Active</div>
                        <div class="stat-pill alert" id="stat-pill-alerts" style="display:none"><span class="stat-pill-value" id="dash-alerts">0</span> Alerts</div>
                        <div class="stat-pill connection" id="stat-pill-connections" style="display:none"><span class="stat-pill-value" id="dash-connections">0</span> Connections</div>
                    </div>
                    <div class="command-actions">
                        <button id="btn-cascade" class="btn btn-gold btn-lg">
                            Cascade Intelligence
                            <span class="btn-sub">Autonomous 50+ tool investigation</span>
                        </button>
                        <button id="btn-health-check" class="btn btn-secondary">
                            Health Check
                        </button>
                        <button id="btn-add-widget" class="btn btn-ghost btn-sm">
                            + Widget
                        </button>
                    </div>
                </div>

                <!-- Cascade Progress -->
                <div id="cascade-progress" class="cascade-progress hidden">
                    <div class="cascade-pipeline">
                        <div class="cascade-step active" id="cascade-step-1" data-label="Autonomous Investigation">
                            <span class="cascade-step-num">1</span>
                            <span class="cascade-step-label">Autonomous Investigation</span>
                            <span class="cascade-agentic-badge">Tool-Use Agent</span>
                        </div>
                    </div>
                    <div id="cascade-status" class="cascade-status"></div>
                    <div id="cascade-tool-log" class="cascade-tool-log"></div>
                </div>

                <!-- Smart Actions Bar -->
                <div id="smart-actions-bar" class="smart-actions-bar hidden">
                    <div class="smart-actions-header">
                        <span>AI Recommended Actions</span>
                    </div>
                    <div id="smart-actions-list" class="smart-actions-list"></div>
                </div>

                <!-- Custom Widgets Container -->
                <div id="custom-widgets" class="custom-widgets"></div>

                <!-- Two-column dashboard grid -->
                <div class="dashboard-grid">
                    <div class="dashboard-col-primary">
                        <!-- Risk Heatmap -->
                        <div id="risk-heatmap" class="panel risk-heatmap hidden">
                            <h3>Caseload Risk Heatmap <span id="heatmap-case-count" class="badge">0</span></h3>
                            <div id="risk-heatmap-grid" class="risk-heatmap-grid"></div>
                            <div class="risk-legend">
                                <span class="risk-legend-label">Low</span>
                                <div class="risk-legend-bar"></div>
                                <span class="risk-legend-label">Critical</span>
                            </div>
                            <div id="risk-tooltip" class="risk-tooltip hidden"></div>
                        </div>

                        <!-- Priority Actions -->
                        <div id="priority-actions" class="panel priority-panel hidden">
                            <h3>Priority Actions</h3>
                            <div id="actions-list" class="actions-list"></div>
                        </div>
                    </div>
                    <div class="dashboard-col-secondary">
                        <!-- Alerts & Connections -->
                        <div class="dashboard-panels" id="dashboard-panels" style="display:none">
                            <div class="panel alerts-panel">
                                <h3>
                                    Alerts
                                    <span id="alert-count" class="badge">0</span>
                                </h3>
                                <div id="alerts-list" class="alerts-list"></div>
                            </div>
                            <div class="panel connections-panel">
                                <h3>
                                    Cross-Case Connections
                                    <span id="connection-count" class="badge">0</span>
                                </h3>
                                <div id="connections-list" class="connections-list"></div>
                            </div>
                        </div>

                        <!-- Memory / Prior Insights Panel -->
                        <div id="memory-panel" class="panel memory-panel hidden">
                            <h3>Analysis Memory <span id="memory-count" class="badge">0</span></h3>
                            <div id="memory-list" class="memory-list"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Case Detail View -->
            <div id="view-case" class="view">
                <div class="case-header">
                    <button id="btn-back" class="btn btn-ghost">&larr; Back to Dashboard</button>
                    <h2 id="case-title"></h2>
                    <div class="case-actions">
                        <button id="btn-hearing-prep" class="btn btn-primary btn-hearing">
                            Hearing Prep
                        </button>
                        <button id="btn-deep-analysis" class="btn btn-secondary">
                            Deep Analysis
                        </button>
                        <button id="btn-adversarial" class="btn btn-secondary">
                            Adversarial Sim
                        </button>
                        <button id="btn-motion" class="btn btn-secondary">
                            Draft Motion
                        </button>
                        <button id="btn-client-letter" class="btn btn-secondary">
                            Client Letter
                        </button>
                    </div>
                </div>
                <div class="case-body">
                    <div id="case-hero-zone"></div>
                    <!-- Tab Bar -->
                    <div class="case-tab-bar" id="case-tab-bar">
                        <button class="case-tab active" data-tab="overview">Overview</button>
                        <button class="case-tab" data-tab="evidence">Evidence</button>
                        <button class="case-tab" data-tab="notes">Notes</button>
                    </div>
                    <!-- Tab Panels -->
                    <div class="case-tab-content">
                        <div class="case-tab-panel active" id="tab-overview">
                            <div class="case-info" id="case-info"></div>
                        </div>
                        <div class="case-tab-panel" id="tab-evidence">
                            <div id="case-evidence-summary"></div>
                            <div class="case-law-search">
                                <h3>Case Law Search</h3>
                                <div class="case-law-input-row">
                                    <input type="text" id="case-law-query" class="case-law-input" placeholder="Search Georgia case law (e.g. 'aggravated assault self-defense')">
                                    <select id="case-law-court" class="case-law-court">
                                        <option value="ga">Georgia</option>
                                        <option value="gaappeals">GA Court of Appeals</option>
                                        <option value="gasuperct">GA Supreme Court</option>
                                        <option value="">All Courts</option>
                                    </select>
                                    <button id="btn-case-law-search" class="btn btn-secondary btn-sm">Search</button>
                                </div>
                                <div id="case-law-results" class="case-law-results hidden"></div>
                            </div>
                            <div id="case-evidence" class="case-evidence hidden">
                                <h3>Evidence Items</h3>
                                <div id="evidence-grid" class="evidence-grid"></div>
                            </div>
                        </div>
                        <div class="case-tab-panel" id="tab-notes">
                            <div id="case-notes-content"></div>
                        </div>
                    </div>
                    <div class="case-analysis" id="case-analysis">
                        <p class="empty-hint">Select an analysis mode above</p>
                    </div>
                </div>
                <!-- Deep Analysis Thinking Panel (inline, below case body) -->
                <div id="deep-analysis-panel" class="deep-analysis-panel hidden">
                    <details class="thinking-details" id="deep-thinking-details" open>
                        <summary>
                            <span class="thinking-icon pulse">&bull;</span>
                            AI Reasoning
                            <span id="deep-thinking-count" class="thinking-count"></span>
                        </summary>
                        <div id="deep-thinking-stream" class="side-stream deep-thinking-stream"></div>
                    </details>
                    <div id="deep-response-status" class="deep-response-status hidden">
                        <span class="thinking-icon pulse">&bull;</span>
                        <span id="deep-response-status-text">Generating structured analysis...</span>
                    </div>
                </div>
            </div>

            <!-- Thinking View (overlay during analysis) -->
            <div id="view-thinking" class="view">
                <div class="thinking-header">
                    <div class="thinking-title">
                        <span class="thinking-icon pulse">&bull;</span>
                        <h2 id="thinking-title-text">Analyzing...</h2>
                    </div>
                    <div id="thinking-meta" class="thinking-meta">
                        <span id="thinking-tokens" class="meta-item">0 tokens</span>
                        <span id="thinking-elapsed" class="meta-item">0s</span>
                    </div>
                </div>
                <div id="thinking-stream" class="thinking-stream"></div>
                <div id="thinking-response" class="thinking-response hidden">
                    <h3>Analysis Output</h3>
                    <div id="response-content"></div>
                </div>
            </div>

            <!-- Adversarial View -->
            <div id="view-adversarial" class="view adversarial-view">
                <!-- Header -->
                <div class="adversarial-header">
                    <button id="btn-adversarial-back" class="btn btn-ghost">&larr; Back to Case</button>
                    <h2>Adversarial Simulation</h2>
                    <span id="adversarial-case" class="case-ref"></span>
                </div>

                <!-- Phase Progress Bar -->
                <div class="adversarial-progress">
                    <div class="phase-step active" id="phase-step-1">
                        <span class="phase-num">1</span>
                        <span class="phase-label">Prosecution Brief</span>
                    </div>
                    <div class="phase-connector" id="phase-conn-1"></div>
                    <div class="phase-step" id="phase-step-2">
                        <span class="phase-num">2</span>
                        <span class="phase-label">Defense Response</span>
                    </div>
                    <div class="phase-connector" id="phase-conn-2"></div>
                    <div class="phase-step" id="phase-step-3">
                        <span class="phase-num">3</span>
                        <span class="phase-label">Judicial Analysis</span>
                    </div>
                </div>

                <!-- Adversarial Grid: Left/Right/Bottom -->
                <div class="adversarial-briefs">
                    <!-- Phase 1: Prosecution -->
                    <div class="adversarial-brief prosecution" id="side-prosecution">
                        <div class="brief-header prosecution">
                            <span class="brief-phase">Phase 1</span>
                            <h3>Prosecution Brief</h3>
                        </div>
                        <details class="thinking-details" id="prosecution-thinking-details">
                            <summary>
                                <span class="thinking-icon pulse"></span>
                                Reasoning
                                <span id="prosecution-thinking-count" class="thinking-count"></span>
                            </summary>
                            <div id="prosecution-thinking" class="side-stream"></div>
                        </details>
                        <div class="brief-body">
                            <div id="prosecution-response" class="side-content markdown-body"></div>
                        </div>
                    </div>

                    <!-- Phase 2: Defense -->
                    <div class="adversarial-brief defense" id="side-defense">
                        <div class="brief-header defense">
                            <span class="brief-phase">Phase 2</span>
                            <h3>Defense Response</h3>
                        </div>
                        <details class="thinking-details" id="defense-thinking-details">
                            <summary>
                                <span class="thinking-icon pulse"></span>
                                Reasoning
                                <span id="defense-thinking-count" class="thinking-count"></span>
                            </summary>
                            <div id="defense-thinking" class="side-stream"></div>
                        </details>
                        <div class="brief-body">
                            <div id="defense-response" class="side-content markdown-body"></div>
                        </div>
                    </div>

                    <!-- Phase 3: Judicial Analysis -->
                    <div class="adversarial-brief judge" id="judge-panel">
                        <div class="brief-header judge">
                            <span class="brief-phase">Phase 3</span>
                            <h3>Judicial Analysis</h3>
                            <span class="brief-subtitle">Objective assessment by senior judicial analyst</span>
                        </div>
                        <details class="thinking-details" id="judge-thinking-details">
                            <summary>
                                <span class="thinking-icon pulse"></span>
                                Reasoning
                                <span id="judge-thinking-count" class="thinking-count"></span>
                            </summary>
                            <div id="judge-thinking" class="side-stream"></div>
                        </details>
                        <div class="brief-body">
                            <div id="judge-response" class="side-content markdown-body"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Motion View -->
            <div id="view-motion" class="view">
                <div class="motion-header">
                    <button id="btn-motion-back" class="btn btn-ghost">&larr; Back to Case</button>
                    <h2 id="motion-title">Motion</h2>
                    <div class="motion-meta">
                        <span id="motion-length" class="meta-item"></span>
                        <span id="citation-status" class="meta-item citation-status hidden"></span>
                        <button id="btn-motion-print" class="btn btn-secondary btn-print">Print</button>
                        <button id="btn-motion-copy" class="btn btn-secondary">Copy</button>
                        <button id="btn-motion-download" class="btn btn-secondary btn-export">Download</button>
                    </div>
                </div>
                <div id="motion-case-banner" class="motion-case-banner hidden">
                    <span id="motion-case-ref" class="motion-case-ref"></span>
                    <span id="motion-defendant" class="motion-defendant"></span>
                </div>
                <div id="motion-content" class="motion-content markdown-body"></div>
                <!-- Citation Verification Panel -->
                <div id="citation-panel" class="citation-panel hidden">
                    <div class="citation-panel-header">
                        <h3>Citation Verification</h3>
                        <span id="citation-summary" class="citation-summary"></span>
                    </div>
                    <div id="citation-list" class="citation-list"></div>
                </div>
            </div>
        </main>

        <!-- Right Panel: AI Thinking Stream (visible during analysis) -->
        <aside id="right-panel" class="right-panel hidden">
            <div class="right-panel-header">
                <h3><span class="thinking-icon pulse">&bull;</span> AI Reasoning</h3>
                <span id="right-thinking-tokens" class="meta-item">0 tokens</span>
            </div>
            <div id="right-thinking-stream" class="thinking-stream"></div>
        </aside>
    </div>

    <!-- Chat Panel (slide-in overlay) -->
    <div id="chat-panel" class="chat-panel hidden">
        <div class="chat-header">
            <div class="chat-header-left">
                <h3>Caseload Chat</h3>
                <span class="chat-subtitle">Ask anything about your 500 cases</span>
            </div>
            <div class="chat-header-right">
                <button id="btn-chat-clear" class="btn btn-ghost btn-sm" title="Clear history">Clear</button>
                <button id="btn-chat-close" class="btn btn-ghost btn-sm">&times;</button>
            </div>
        </div>
        <div id="chat-messages" class="chat-messages">
            <div class="chat-welcome">
                <p class="chat-welcome-title">Ask your caseload anything</p>
                <p class="chat-welcome-hint">Try these:</p>
                <div class="chat-suggestions">
                    <button class="chat-suggestion" data-q="Which cases have hearings this week and what should I prepare for?">Hearings this week</button>
                    <button class="chat-suggestion" data-q="Which of my cases are most at risk for speedy trial violations?">Speedy trial risks</button>
                    <button class="chat-suggestion" data-q="Do any of my cases share the same arresting officer? Are there credibility concerns?">Officer patterns</button>
                    <button class="chat-suggestion" data-q="Compare the plea offers across my drug possession cases. Which ones seem unfair?">Plea comparison</button>
                </div>
            </div>
        </div>
        <div class="chat-input-area">
            <input type="text" id="chat-input" class="chat-input" placeholder="Ask about your caseload..." autocomplete="off">
            <button id="btn-chat-send" class="btn btn-primary btn-chat-send">Send</button>
        </div>
    </div>

    <!-- Widget Creator Modal -->
    <div id="widget-modal" class="modal hidden">
        <div class="modal-content widget-modal-content">
            <h3>Create Dashboard Widget</h3>
            <p class="modal-hint">Tell Opus 4.6 what you want to see. It will analyze all 500 cases and build it.</p>
            <input type="text" id="widget-request" class="widget-request-input" placeholder="e.g., Show me all cases where bond exceeds $10K and defendant is still detained..." autocomplete="off">
            <div class="widget-suggestions">
                <button class="btn btn-ghost widget-suggestion" data-req="Show me a calendar view of all hearings in the next 30 days with case severity">Hearing Calendar</button>
                <button class="btn btn-ghost widget-suggestion" data-req="Which prosecutors am I dealing with most, and what are their plea offer patterns?">Prosecutor Analysis</button>
                <button class="btn btn-ghost widget-suggestion" data-req="Rank my cases by likelihood of dismissal and explain why for each">Dismissal Odds</button>
                <button class="btn btn-ghost widget-suggestion" data-req="Which of my clients have been in custody longest relative to the severity of their charges?">Custody Review</button>
            </div>
            <div class="modal-actions">
                <button id="btn-widget-create" class="btn btn-primary">Build Widget</button>
                <button id="btn-widget-cancel" class="btn btn-ghost">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Motion Type Modal -->
    <div id="motion-modal" class="modal hidden">
        <div class="modal-content">
            <h3>Select Motion Type</h3>
            <div class="motion-options">
                <button class="btn btn-motion-option" data-type="Motion to Suppress Evidence">Motion to Suppress Evidence</button>
                <button class="btn btn-motion-option" data-type="Motion to Dismiss">Motion to Dismiss</button>
                <button class="btn btn-motion-option" data-type="Brady Motion (Disclosure of Exculpatory Evidence)">Brady / Giglio Motion</button>
                <button class="btn btn-motion-option" data-type="Motion to Compel Discovery">Motion to Compel Discovery</button>
                <button class="btn btn-motion-option" data-type="Motion for Speedy Trial">Motion for Speedy Trial</button>
                <button class="btn btn-motion-option" data-type="Motion to Reduce Bond">Motion to Reduce Bond</button>
            </div>
            <button id="btn-modal-close" class="btn btn-ghost">Cancel</button>
        </div>
    </div>

    <!-- Evidence Lightbox -->
    <div id="evidence-lightbox" class="evidence-lightbox hidden" onclick="closeEvidenceLightbox(event)">
        <button class="lightbox-close" onclick="closeEvidenceLightbox()">&times;</button>
        <div class="lightbox-title" id="lightbox-title"></div>
        <div class="lightbox-body" id="lightbox-body"></div>
    </div>

    <script src="/static/js/app.js"></script>
</body>
</html>
